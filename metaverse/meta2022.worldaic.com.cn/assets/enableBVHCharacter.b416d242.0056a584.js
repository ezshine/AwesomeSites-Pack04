import{j as C,l as w,k as G,m as z,o as U,p as F,H,q as N,v as P,M as j,r as k,x as R,B as T,C as V,D as W,s as q,E as D,U as I,F as L,t as X,Y as Z}from"./index.ff37fac8.js";import{s as A}from"./useBVHMap.eb7f5eaa.1812c0a6.js";import{x as B}from"./PhysicsUpdate.5bde1e91.01738e86.js";const f=new Set,J=()=>new WeakSet;C(function(){if(U())return;const e=A();if(!e.length)return;const n=w(),x=G(),d=.02,c=z(),E=F(()=>{H.clear();for(const t of f){const s=t.bvhVelocity,o=t.outerObject3d,l=t.bvhHalfHeight,i=c?l:t.bvhRadius;c?s.add(t.bvhOnGround||t._gravity===!1?N:P(o).normalize().multiplyScalar(d*-n*j[0])):s.y+=t.bvhOnGround||t._gravity===!1?0:d*-n*j[0];const h=t.positionUpdate;h.x&&(s.x=0),h.y&&(s.y=0),h.z&&(s.z=0),h.reset(),o.position.addScaledVector(s,d),o.updateMatrixWorld();const{start:r,end:u}=V;u.copy(r.copy(o.position));const O=Math.max(l-i,0);u.y+=O,r.y-=O;const Y=r.clone();k.setFromCenterAndSize(o.position,R.set(i*2,l*2,i*2));const S=X,M=Z;let p=0,m,b=!1,v;for(const g of e)v=T.get(g),g.shapecast({intersectsBounds:y=>y.intersectsBox(k),intersectsTriangle:y=>{p=y.closestPointToSegment(V,S,M),p<i&&(b=!0,m=M.sub(S).normalize().multiplyScalar(i-p),r.add(m),u.add(m))}});b&&v&&W(H,t,J).add(v);const a=r.sub(Y);c?t.bvhOnGround=b:(t.bvhOnGround=a.y>Math.abs(d*s.y*.25),x&&t.bvhOnGround&&Math.abs(a.y/(a.x+a.z+Number.EPSILON))<x&&(t.bvhOnGround=!1));const _=Math.max(0,a.length()-1e-5);a.normalize().multiplyScalar(_),o.position.add(a),t.bvhOnGround?s.set(0,0,0):(a.normalize(),s.addScaledVector(a,-a.dot(s)))}});return()=>{E.cancel()}},[A,w,G,z,U]);function tt(e){if(e.done)return;q.attach(this.outerObject3d),this instanceof D&&(this.width=this.depth=Math.min(this.width,this.depth)),this.rotationUpdate=new B,this.positionUpdate=new B;const n=I(this).multiplyScalar(.5);this.bvhHalfHeight=Math.max(n.y,.5),this.bvhRadius=Math.max(n.x,.5),this.bvhVelocity=new L,f.add(this),e.then(()=>{f.delete(this),this.rotationUpdate=void 0,this.positionUpdate=void 0})}export{tt as default};
